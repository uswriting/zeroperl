#!/usr/bin/env python3
"""
wasic - WASI Compiler Wrapper
Handles compilation requests, either building for host (test programs)
or targeting WASI (actual build)
"""
import os
import sys
import shlex
from subprocess import check_call, CalledProcessError, DEVNULL

def is_test_compile(args):
    """Detect if this is a test compilation (like from Configure)"""
    source_files = [arg for arg in args if arg.endswith('.c')]
    return any('try' in f or 'test' in f for f in source_files)

def compile_for_host(args):
    """Compile using host compiler for test programs"""
    cmd = ['cc'] + args
    print(f"Host compile: {' '.join(cmd)}", file=sys.stderr)
    try:
        check_call(cmd)
        return 0
    except CalledProcessError as e:
        return e.returncode

def compile_for_wasi(args):
    """Compile using WASI SDK"""
    wasi_sdk_path = os.getenv('WASI_SDK_PATH', '/opt/wasi-sdk')
    wasi_sysroot = os.path.join(wasi_sdk_path, 'share/wasi-sysroot')
    
    cmd = [
        f"{wasi_sdk_path}/bin/clang",
        f"--sysroot={wasi_sysroot}",
        "--target=wasm32-wasi"
    ] + args
    
    print(f"WASI compile: {' '.join(cmd)}", file=sys.stderr)
    try:
        check_call(cmd)
        return 0
    except CalledProcessError:
        return None  # Return None to indicate failure without printing error

def main():
    if len(sys.argv) < 2:
        print("Usage: wasic [compiler flags and source files]", file=sys.stderr)
        return 1

    args = sys.argv[1:]
    
    if is_test_compile(args):
        try:
            # Try WASI compilation first, suppressing stderr
            cmd = [
                f"{os.getenv('WASI_SDK_PATH', '/opt/wasi-sdk')}/bin/clang",
                f"--sysroot={os.getenv('WASI_SDK_PATH', '/opt/wasi-sdk')}/share/wasi-sysroot",
                "--target=wasm32-wasi"
            ] + args
            check_call(cmd, stderr=DEVNULL)
            print("Test compile succeeded with WASI, building host executable", file=sys.stderr)
            # If WASI succeeded, compile for host to get test executable
            return compile_for_host(args)
        except CalledProcessError:
            print("Test compile failed with WASI", file=sys.stderr)
            return 1
    else:
        # For non-test compiles, use WASI only
        return compile_for_wasi(args)

if __name__ == '__main__':
    sys.exit(main())
